# docker-compose --env-file=.env.local up

version: "3.9"
services:
  nginx:
    image: al-nginx
    build:
      context: nginx
    ports:
      - 80:80
      - 443:443
    restart: always
  missionControl:
    image: docker.pkg.github.com/opendata-mvcr/mission-control/mission-control:latest
    environment:
      CONTEXT:
      ID: missionControl
      URL: ${URL}
      COMPONENTS:
    restart: always
  ontographer:
    image: docker.pkg.github.com/opendata-mvcr/ontographer/ontographer:latest
    environment:
      CONTEXT:
      ID: ontographer
      URL: ${URL}/v-nástroji/ontographer
      COMPONENTS:
    restart: always
  termit:
    image: docker.pkg.github.com/opendata-mvcr/termit-ui/al-termit-ui:latest
    environment:
      CONTEXT:
      ID: termit
      URL: ${URL}/v-nástroji/termit
      COMPONENTS:
  dbServer:
    image: al-graphdb
    build:
      context: dbServer
      args:
        GRAPHDB_ZIP: graphdb-free-9.6.0-dist.zip
    environment:
      CONTEXT:
      ID: dbServer
      URL: ${URL}/sluzby/dbServer/repositories/assembly-line
      COMPONENTS: # TODO REPOSITORY_USERNAME and REPOSITORY_PASSWORD
      GRAPHDB_WORKBENCH_EXTERNAL_URL: ${URL}/sluzby/dbServer
      GRAPHDB_EXTERNAL_URL: ${URL}/sluzby/dbServer
    restart: always
    volumes:
      - al-graphdb:/graphdb/home
  keycloakPostgres:
    image: postgres
    volumes:
      - al-keycloak-postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_DB:
      POSTGRES_USER:
      POSTGRES_PASSWORD:
    restart: always
  authServer:
    image: docker.pkg.github.com/opendata-mvcr/keycloak-graphdb-user-replicator/al-keycloak:latest
    volumes:
      - al-keycloak:/keycloak
      - /etc/ssl/private/tls.key:/etc/x509/https/tls.key
      - /etc/ssl/certs/tls.crt:/etc/x509/https/tls.crt
      - ./authServer:/authServer
    environment:
      CONTEXT:
      ID: authServer
      URL: ${URL}/sluzby/authServer/realms/assembly-line
      COMPONENTS: # then REPOSITORY_USERNAME and REPOSITORY_PASSWORD
      DB_VENDOR: POSTGRES
      DB_ADDR: keycloakPostgres
      DB_DATABASE: ${POSTGRES_DB}
      DB_USER: ${POSTGRES_USER}
      DB_SCHEMA: public
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      REALM_ID: assembly-line
      KEYCLOAK_USER:
      KEYCLOAK_PASSWORD:
      PROXY_ADDRESS_FORWARDING: "true"
      KEYCLOAK_FRONTEND_URL: ${URL}/sluzby/authServer
      KEYCLOAK_IMPORT: /authServer/keycloak-realm.json
      DB_SERVER_URL: http://dbServer:7200
      DB_SERVER_REPOSITORY_ID: assembly-line
      DB_SERVER_CONTEXT: https://slovník.gov.cz/uživatel
      NAMESPACE: https://slovník.gov.cz/uživatel/
    depends_on:
      - keycloakPostgres
      - dbServer
    restart: always
  sgovServer:
    image: docker.pkg.github.com/opendata-mvcr/sgov/al-sgov:latest
    environment:
      CONTEXT:
      ID: sgovServer
      URL: ${URL}/sluzby/sgovServer
      COMPONENTS:
      REPOSITORY_URL: http://dbServer:7200/repositories/assembly-line
      KEYCLOAK_REALM: assembly-line
      KEYCLOAK_RESOURCE: sgovServer
      KEYCLOAK_AUTHSERVERURL: http://authServer:8080/modelujeme/sluzby/authServer
      KEYCLOAK_REALMKEY: ${KEYCLOAK_REALMKEY}
      KEYCLOAK_CREDENTIALS_SECRET: ${SGOV_SERVER_KEYCLOAK_CREDENTIALS_SECRET}
      KEYCLOAK_PUBLIC_CLIENT: "false"
      REPOSITORY_GITHUBUSERTOKEN: ${SGOV_SERVER_REPOSITORY_GITHUBUSERTOKEN}
      USER_NAMESPACE: https://slovník.gov.cz/uživatel/
      USER_CONTEXT: https://slovník.gov.cz/uživatel
    depends_on:
      - dbServer
      - authServer
    restart: always
  termitServer:
    image: docker.pkg.github.com/opendata-mvcr/termit/al-termit:latest
    environment:
      CONTEXT:
      ID: termitServer
      URL: ${URL}/sluzby/termitServer
      COMPONENTS:
      CORS_ALLOWEDORIGIN: "*"
      CANONICAL_CACHE_CONTAINER: https://slovník.gov.cz
      SERVER_SERVLET_CONTEXT-PATH: /modelujeme/sluzby/termitServer
      REPOSITORY_URL: http://dbServer:7200/repositories/assembly-line
      KEYCLOAK_REALM: assembly-line
      KEYCLOAK_RESOURCE: termitServer
      KEYCLOAK_AUTHSERVERURL: http://authServer:8080/modelujeme/sluzby/authServer
      KEYCLOAK_REALMKEY: ${KEYCLOAK_REALMKEY}
      KEYCLOAK_CREDENTIALS_SECRET: ${TERMIT_SERVER_KEYCLOAK_CREDENTIALS_SECRET}
      KEYCLOAK_PUBLIC_CLIENT: "false"
      USER_NAMESPACE: https://slovník.gov.cz/uživatel/
      USER_CONTEXT: https://slovník.gov.cz/uživatel
    depends_on:
      - dbServer
      - authServer
    restart: always

volumes:
  al-graphdb:
  al-keycloak-postgres:
  al-keycloak:
